"use strict";(self.webpackChunktutorial_of_ai_kit=self.webpackChunktutorial_of_ai_kit||[]).push([[446],{106:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>a,metadata:()=>l,toc:()=>h});var t=o(5893),r=o(1151);const a={sidebar_position:2},i=void 0,l={id:"Chapter 5 - Custom Model Development and Deployment/Convert Your Model",title:"Convert Your Model",description:"You can get this Notebook on GitHub.",source:"@site/../articles/Chapter 5 - Custom Model Development and Deployment/Convert Your Model.md",sourceDirName:"Chapter 5 - Custom Model Development and Deployment",slug:"/Chapter 5 - Custom Model Development and Deployment/Convert Your Model",permalink:"/Tutorial-of-AI-Kit-with-Raspberry-Pi-From-Zero-to-Hero/docs/Chapter 5 - Custom Model Development and Deployment/Convert Your Model",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Training Your Model",permalink:"/Tutorial-of-AI-Kit-with-Raspberry-Pi-From-Zero-to-Hero/docs/Chapter 5 - Custom Model Development and Deployment/Training Your Model"},next:{title:"Deploy Your Model",permalink:"/Tutorial-of-AI-Kit-with-Raspberry-Pi-From-Zero-to-Hero/docs/Chapter 5 - Custom Model Development and Deployment/Deploy Your Model"}},s={},h=[{value:"Step 1: Prepare your environment on your host computer",id:"step-1-prepare-your-environment-on-your-host-computer",level:2},{value:"Step 2: Open Netron",id:"step-2-open-netron",level:2},{value:"Step 3: Parse the model",id:"step-3-parse-the-model",level:2},{value:"Step 4: Model Optimization",id:"step-4-model-optimization",level:2},{value:"Step 5: Compile Hailo Archive Quantized Model to HEF",id:"step-5-compile-hailo-archive-quantized-model-to-hef",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",img:"img",p:"p",pre:"pre",strong:"strong",...(0,r.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["You can get this ",(0,t.jsx)(n.a,{href:"https://github.com/Seeed-Projects/Tutorial-of-AI-Kit-with-Raspberry-Pi-From-Zero-to-Hero/blob/main/articles/Chapter%205%20-%20Custom%20Model%20Development%20and%20Deployment/Convert%20Your%20Model.ipynb",children:"Notebook"})," on GitHub."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"step-1-prepare-your-environment-on-your-host-computer",children:"Step 1: Prepare your environment on your host computer"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Note: This part of code run on your host computer"})}),"\n",(0,t.jsxs)(n.p,{children:["The Jupyter Notebook right up have a button like ",(0,t.jsx)(n.img,{alt:"select kernel",src:o(5260).Z+"",width:"113",height:"23"}),", then you choose ",(0,t.jsx)(n.code,{children:"Select Another Kernel"}),", and choose ",(0,t.jsx)(n.code,{children:"Python Environments"}),", then choose ",(0,t.jsx)(n.code,{children:"Creat Python Environment"})," and choose ",(0,t.jsx)(n.code,{children:"Venv"}),", then choose ",(0,t.jsx)(n.code,{children:"python3.10"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"# Here is my hostcomputer information\n# Linux PC 6.8.0-45-generic #45~22.04.1-Ubuntu SMP PREEMPT_DYNAMIC Wed Sep 11 15:25:05 UTC 2 x86_64 x86_64 x86_64 GNU/Linux\n\n!uname -a\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"# Here is my python version\n# Python 3.10.12\n\n!python -V\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"# Download gdown to install software from google driver, if you see 'install successfully' it means you install libs successfully, or when you see 'install error' it means you install libs unsuccessfully\ntry:\n    %pip install gdown -q\n    print('install successfully')\nexcept:\n    print('install error')\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"# Install hailo_dataflow_compiler-3.28.0-py3-none-linux_x86_64.whl from google driver\n\n\n!gdown https://drive.google.com/uc?id=1BbEbNIrmAJkzc5Lrgcji92Nskx6gbJ_X -O ../resource/\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"# Install HailoDFC to compile the model\ntry:\n    %pip install ../resource/hailo_dataflow_compiler-3.28.0-py3-none-linux_x86_64.whl -q\n    print('install successfully')\nexcept:\n    print('install error')\n"})}),"\n",(0,t.jsxs)(n.h2,{id:"step-2-open-netron",children:["Step 2: Open ",(0,t.jsx)(n.a,{href:"https://netron.app/",children:"Netron"})]}),"\n",(0,t.jsxs)(n.p,{children:["For parsing ONNX model, we should find the input node and output node from computational graph, open faster_rcnn.onnx from ",(0,t.jsx)(n.a,{href:"https://netron.app/",children:"netron"}),":"]}),"\n",(0,t.jsxs)(n.p,{children:["The below image show that the input node name is ",(0,t.jsx)(n.code,{children:"/model.0/conv/Conv"})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"yolov11n_1",src:o(8370).Z+"",width:"1916",height:"930"})}),"\n",(0,t.jsxs)(n.p,{children:["The below image show that the output node name is ",(0,t.jsx)(n.code,{children:"/model.23/Concat_5"})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"yolov11n_2",src:o(1501).Z+"",width:"653",height:"812"})}),"\n",(0,t.jsx)(n.h2,{id:"step-3-parse-the-model",children:"Step 3: Parse the model"}),"\n",(0,t.jsx)(n.p,{children:'Hailo Archive is a tar.gz archive file that captures the "state" of the model - the files and attributes used in a given stage from parsing to compilation. Use the save_har method to save the runner\'s state in any stage and load_har method to load a saved state to an uninitialized runner.'}),"\n",(0,t.jsx)(n.p,{children:"The initial HAR file includes:"}),"\n",(0,t.jsx)(n.p,{children:"HN file, which is a JSON-like representation of the graph structure that is deployed to the Hailo hardware."}),"\n",(0,t.jsx)(n.p,{children:"NPZ file, which includes the weights of the model."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"import tensorflow as tf\nfrom IPython.display import SVG\n\n# import the ClientRunner class from the hailo_sdk_client package\nfrom hailo_sdk_client import ClientRunner\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'# Define the model name and onnx model path\nonnx_model_name = "yolov11n"\nonnx_path = "../models/Chapter5/best.onnx"\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:["Note: Sometimes for complex model like yolo the end node is not the last node we parse, so please check ",(0,t.jsx)(n.a,{href:"https://community.hailo.ai/t/parsing-yolo-models-with-the-hailo-dataflow-compiler-tool/2384",children:"parse guild"})," for more information."]})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'# AI kit chip is hailo8l, so we choose hailo8l as hardware arch\nchosen_hw_arch = "hailo8l"\n\nrunner = ClientRunner(hw_arch=chosen_hw_arch)\nhn, npz = runner.translate_onnx_model(\n    onnx_path,\n    onnx_model_name,\n    start_node_names=["/model.0/conv/Conv"], # the name of input node\n    end_node_names=["/model.23/cv2.0/cv2.0.2/Conv", "/model.23/cv3.0/cv3.0.2/Conv", \n                    "/model.23/cv2.1/cv2.1.2/Conv", "/model.23/cv3.1/cv3.1.2/Conv", \n                    "/model.23/cv2.2/cv2.2.2/Conv", "/model.23/cv3.2/cv3.2.2/Conv"], # the name of output node\n    net_input_shapes={"/model.0/conv/Conv": [1, 3, 640, 640]}, # input shape\n)\n'})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'# Save to har model\n\nhailo_model_har_name = f"../models/Chapter5/{onnx_model_name}_hailo_model.har"\nrunner.save_har(hailo_model_har_name)\n'})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"# Use hailo command to parse the model\n\n!hailo visualizer ../models/Chapter5/{onnx_model_name}_hailo_model.har \n"})}),"\n",(0,t.jsx)(n.h2,{id:"step-4-model-optimization",children:"Step 4: Model Optimization"}),"\n",(0,t.jsx)(n.p,{children:"The input is a HAR file in Hailo Model state (before optimization; with native weights) and the output will be a quantized HAR file with quantized weights."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"# General imports used throughout the tutorial\n# file operations\nimport json\nimport os\n\nimport numpy as np\nimport tensorflow as tf\nfrom IPython.display import SVG\nfrom matplotlib import patches\nfrom matplotlib import pyplot as plt\nfrom PIL import Image\nfrom tensorflow.python.eager.context import eager_mode\n\n# import the hailo sdk client relevant classes\nfrom hailo_sdk_client import ClientRunner, InferenceContext\n\n%matplotlib inline\n\nIMAGES_TO_VISUALIZE = 5\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"# The folder of images\nimage_dir = './images'\nimage_files = [f for f in os.listdir(image_dir) if f.endswith(('.png', '.jpg', '.jpeg'))]\n\n# Init the list\nimages = []\n\n# Load every images\nfor image_file in image_files:\n    img_path = os.path.join(image_dir, image_file)\n    img = Image.open(img_path).convert('RGB')  # Transform to RGB format\n    img_array = np.array(img)  # Transform to NumPy format\n    images.append(img_array)\n\n# Transform images to NumPy array\nimages_array = np.array(images)\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'# Load our parsed HAR model\n\nassert os.path.isfile(hailo_model_har_name), "Please provide valid path for HAR file"\nrunner = ClientRunner(har=hailo_model_har_name, hw_arch=chosen_hw_arch)\n# By default it uses the hw_arch that is saved on the HAR. For overriding, use the hw_arch flag.\n'})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'# Call Optimize to perform the optimization process\nrunner.optimize(images_array)\n\n# Save the result state to a Quantized HAR file\nquantized_model_har_path = f"../models/Chapter5/{onnx_model_name}_quantized_model.har"\nrunner.save_har(quantized_model_har_path)\n'})}),"\n",(0,t.jsx)(n.h2,{id:"step-5-compile-hailo-archive-quantized-model-to-hef",children:"Step 5: Compile Hailo Archive Quantized Model to HEF"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"runner = ClientRunner(har=quantized_model_har_path, hw_arch=chosen_hw_arch)\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'hef = runner.compile()\n\nfile_name = f"../models/Chapter5/{onnx_model_name}.hef"\n\nwith open(file_name, "wb") as f:\n    f.write(hef)\n'})})]})}function p(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},5260:(e,n,o)=>{o.d(n,{Z:()=>t});const t="data:image/png;base64,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"},8370:(e,n,o)=>{o.d(n,{Z:()=>t});const t=o.p+"assets/images/yolov11n_1-e0ef5e947901cfbe17d2bee07663b850.png"},1501:(e,n,o)=>{o.d(n,{Z:()=>t});const t=o.p+"assets/images/yolov11n_2-d4741edd6d4ef961e7b8bef40ec6b8f2.png"},1151:(e,n,o)=>{o.d(n,{Z:()=>l,a:()=>i});var t=o(7294);const r={},a=t.createContext(r);function i(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);